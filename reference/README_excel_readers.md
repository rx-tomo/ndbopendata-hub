# Excel個別読み取りシステム

## 概要

NDBオープンデータのExcelファイルを個別に読み取り、SQLに変換するシステムです。
各Excelファイルごとに専用のリーダーを用意することで、ファイル固有の構造に対応し、高品質なデータ抽出を実現します。

## システム構成

```
scripts/excel_readers/
├── common_excel_reader.py      # 共通基底クラス（旧版）
├── common_excel_reader_v2.py   # 共通基底クラス（改良版・2025-07-25）
├── table_mapping.py            # テーブル振り分け定義（2025-07-25）
├── constants.py                # 定数定義
├── readers/                    # 個別リーダー格納ディレクトリ（39ファイル）
│   ├── reader_001495675.py    # BMI都道府県別リーダー
│   ├── reader_001495676.py    # BMI二次医療圏別リーダー
│   ├── reader_001495677.py    # GOT(AST)都道府県別リーダー
│   ├── reader_001495678.py    # GOT(AST)二次医療圏別リーダー
│   └── ...                    # 他のExcelファイル用リーダー
├── tests/                      # テストスクリプト格納ディレクトリ
│   ├── test_reader_001495675.py
│   ├── test_reader_001495676.py
│   ├── test_reader_001495677.py
│   ├── test_reader_001495678.py
│   └── ...                    # 他のテストファイル（計39ファイル）
├── run_all_tests.py           # 全テスト実行&HTMLサマリー生成
├── process_all_excels.py      # 全Excel処理実行（旧版）
├── process_all_excels_v2.py   # 全Excel処理実行（改良版・2025-07-25）
├── sql_output/                 # SQL出力ディレクトリ
├── validation_reports/         # 検証レポート出力ディレクトリ
├── validate_excel_to_sql.py    # Excel→SQL変換検証スクリプト
└── README_excel_readers.md     # このドキュメント
```

## 設計思想

### 1ファイル1リーダー方式

- 問題: 118個のExcelファイルを1つの共通スクリプトで処理すると、複雑性が高くバグの連鎖影響が発生
- 解決: 各Excelファイルに専用のリーダーを作成し、ファイル固有の構造に最適化
- 利点: 
  - 可読性の向上
  - メンテナンス性の向上
  - デバッグの容易さ
  - 品質保証の独立性

### 共通部分と個別部分の分離

- 共通部分（ファイル読み込み、SQL生成の骨格、出力管理）と、個別部分（開始行検出、見出し抽出、行抽出、カラム/テーブルマッピング）を明確に分離。

## 改良版システム（2025-07-25）

主な改善:
1. 年齢グループ形式の統一化（`40～44歳` → `40-44`）
2. テーブル振り分けの自動化（basic/detailed への自動ルーティング）
3. 項目名の正規化（GOT/GPT/γ-GT 等）
4. data_year 既定化（2023）

## 品質保証

- テスト駆動（TDD）: 各リーダーで標準ケースを検証（成功率基準を設定）
- 統合検証: Excel→SQL 変換の妥当性を統合テストで確認
- 4点突合: Excel/DB/API/UI の整合性を自動検証

## 実行時の注意

- リーダー/テストは相対パス前提のため、規定ディレクトリからの実行を推奨
- 非ゼロ優先や HIGH_DASH_FILES 等の例外処理は統合テスト側で一元管理

## 現在の進捗（抜粋）

- 実装済みリーダー: 115ファイル相当（検査71 + 質問票44）
- 実行対象外（平均値データ）: 4ファイル（001495696.xlsx, 001495697.xlsx, 001495862.xlsx, 001495867.xlsx）
- テスト状況: 個別テスト 53件 + 統合テスト（run_all_tests.py）
